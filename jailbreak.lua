local v1 = Instance.new("ScreenGui",game.Players.LocalPlayer.PlayerGui)
local text = "https://discord.gg/XqMG3zYrRr"
setclipboard(text)
local Frame = Instance.new("Frame")
local TextLabel = Instance.new("TextLabel")
local TextLabel_2 = Instance.new("TextLabel")
local TextLabel_3 = Instance.new("TextLabel")
local TextButton = Instance.new("TextButton")
local TextLabel_4 = Instance.new("TextLabel")
local TextLabel_5 = Instance.new("TextLabel")

--Properties:

Frame.Parent = v1
Frame.AnchorPoint = Vector2.new(0.5, 0.5)
Frame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
Frame.BackgroundTransparency = 0.200
Frame.BorderColor3 = Color3.fromRGB(0, 0, 0)
Frame.BorderSizePixel = 0
Frame.Position = UDim2.new(0.499673396, 0, 0.499301672, 0)
Frame.Size = UDim2.new(0.5, 0, 0.5, 0)

TextLabel.Parent = Frame
TextLabel.AnchorPoint = Vector2.new(0.5, 0)
TextLabel.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
TextLabel.BackgroundTransparency = 1.000
TextLabel.BorderColor3 = Color3.fromRGB(0, 0, 0)
TextLabel.BorderSizePixel = 0
TextLabel.Position = UDim2.new(0.5, 0, 0, 0)
TextLabel.Size = UDim2.new(0, 200, 0, 50)
TextLabel.Font = Enum.Font.SourceSans
TextLabel.Text = "Sapien V1"
TextLabel.TextColor3 = Color3.fromRGB(0, 4, 253)
TextLabel.TextScaled = true
TextLabel.TextSize = 14.000
TextLabel.TextWrapped = true

TextLabel_2.Parent = Frame
TextLabel_2.AnchorPoint = Vector2.new(0.5, 0.5)
TextLabel_2.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
TextLabel_2.BackgroundTransparency = 1.000
TextLabel_2.BorderColor3 = Color3.fromRGB(0, 0, 0)
TextLabel_2.BorderSizePixel = 0
TextLabel_2.Position = UDim2.new(0.163291961, 0, 0.394553035, 0)
TextLabel_2.Size = UDim2.new(0, 200, 0, 127)
TextLabel_2.Font = Enum.Font.SourceSans
TextLabel_2.Text = "Join our discord Server for more OP Scripts Link will copied into clipboard"
TextLabel_2.TextColor3 = Color3.fromRGB(0, 4, 253)
TextLabel_2.TextScaled = true
TextLabel_2.TextSize = 14.000
TextLabel_2.TextWrapped = true

TextLabel_3.Parent = Frame
TextLabel_3.AnchorPoint = Vector2.new(0.5, 0.5)
TextLabel_3.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
TextLabel_3.BackgroundTransparency = 1.000
TextLabel_3.BorderColor3 = Color3.fromRGB(0, 0, 0)
TextLabel_3.BorderSizePixel = 0
TextLabel_3.Position = UDim2.new(1, 0, 0.394553035, 0)
TextLabel_3.Size = UDim2.new(0, 200, 0, 127)
TextLabel_3.Font = Enum.Font.SourceSans
TextLabel_3.Text = "DO NOT TURN ON SPEED AND FLY AT SAME TIME"
TextLabel_3.TextColor3 = Color3.fromRGB(0, 4, 253)
TextLabel_3.TextScaled = true
TextLabel_3.TextSize = 14.000
TextLabel_3.TextWrapped = true

TextButton.Parent = Frame
TextButton.BackgroundColor3 = Color3.fromRGB(0, 17, 255)
TextButton.BackgroundTransparency = 0.750
TextButton.BorderColor3 = Color3.fromRGB(0, 0, 0)
TextButton.BorderSizePixel = 0
TextButton.Position = UDim2.new(0.400065303, 0, 0.338687152, 0)
TextButton.Size = UDim2.new(0.200000003, 0, 0.200000003, 0)
TextButton.Font = Enum.Font.SourceSans
TextButton.Text = "PLAY"
TextButton.TextColor3 = Color3.fromRGB(9, 1, 255)
TextButton.TextScaled = true
TextButton.TextSize = 14.000
TextButton.TextWrapped = true

TextLabel_4.Parent = Frame
TextLabel_4.AnchorPoint = Vector2.new(0.5, 0)
TextLabel_4.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
TextLabel_4.BackgroundTransparency = 1.000
TextLabel_4.BorderColor3 = Color3.fromRGB(0, 0, 0)
TextLabel_4.BorderSizePixel = 0
TextLabel_4.Position = UDim2.new(0.5, 0, 0.587569833, 0)
TextLabel_4.Size = UDim2.new(0.100000001, 0, 0.100000001, 0)
TextLabel_4.Font = Enum.Font.SourceSans
TextLabel_4.Text = "CREDITS:"
TextLabel_4.TextColor3 = Color3.fromRGB(0, 25, 249)
TextLabel_4.TextSize = 14.000

TextLabel_5.Parent = Frame
TextLabel_5.AnchorPoint = Vector2.new(0.5, 1)
TextLabel_5.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
TextLabel_5.BackgroundTransparency = 1.000
TextLabel_5.BorderColor3 = Color3.fromRGB(0, 0, 0)
TextLabel_5.BorderSizePixel = 0
TextLabel_5.Position = UDim2.new(0.5, 0, 1, 0)
TextLabel_5.Size = UDim2.new(0.300000012, 0, 0.400000006, 0)
TextLabel_5.Font = Enum.Font.SourceSans
TextLabel_5.Text = "URAVGSCRIPTER"
TextLabel_5.TextColor3 = Color3.fromRGB(0, 4, 254)
TextLabel_5.TextScaled = true
TextLabel_5.TextSize = 14.000
TextLabel_5.TextWrapped = true

local s1 = Instance.new("ScreenGui",game.Players.LocalPlayer.PlayerGui)
s1.Enabled = false
s1.ResetOnSpawn = false
local Frame = Instance.new("Frame")
Frame.ZIndex = 2
local TextButton2 = Instance.new("TextButton")

Frame.Parent = s1
Frame.AnchorPoint = Vector2.new(0,0.5)
Frame.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
Frame.BackgroundTransparency = 1.000
Frame.BorderColor3 = Color3.fromRGB(0, 0, 0)
Frame.BorderSizePixel = 0
Frame.Position = UDim2.new(0,0.5)
Frame.Size = UDim2.new(0.100000001, 0, 0.100000001, 0)

TextButton2.Parent = Frame
TextButton2.AnchorPoint = Vector2.new(0.5,0.5)
TextButton2.BackgroundColor3 = Color3.fromRGB(9, 1, 255)
TextButton2.BackgroundTransparency = 0.500
TextButton2.BorderColor3 = Color3.fromRGB(0, 0, 0)
TextButton2.BorderSizePixel = 0
TextButton2.Position = UDim2.new(0.5, 0, 0.5, 0)
TextButton2.Size = UDim2.new(0, 123, 0, 57)
TextButton2.Font = Enum.Font.SourceSans
TextButton2.Text = "SAPIEN V1"
TextButton2.TextColor3 = Color3.fromRGB(1, 1, 255)
TextButton2.TextScaled = true
TextButton2.TextSize = 14.000
TextButton2.TextWrapped = true



TextButton.MouseButton1Click:Connect(function()
	v1.Enabled = false
	s1.Enabled = true
end)

local cloneref = cloneref or function(...) return ... end

local ReplicatedStorage = cloneref(game:GetService("ReplicatedStorage"))
local workspace = cloneref(game:GetService("Workspace"))
local players = cloneref(game:GetService("Players"))
local lplr = players.LocalPlayer

local sapien = Instance.new("ScreenGui")
sapien.Parent = lplr.PlayerGui 
sapien.Enabled = false
sapien.ResetOnSpawn = false

local jb = {
	FallingController = require(cloneref(ReplicatedStorage.Game.Falling)),
    GunController = require(cloneref(ReplicatedStorage.Game.Item.Gun)),
    VehicleController = require(cloneref(ReplicatedStorage.Vehicle.VehicleUtils)),
    ItemSystemController = require(cloneref(ReplicatedStorage.Game.ItemSystem.ItemSystem)),
    GunUtils = require(cloneref(ReplicatedStorage.Game.GunShop.GunUtils)),
    BulletEmitter = require(cloneref(ReplicatedStorage.Game.ItemSystem.BulletEmitter))
}
debug.setconstant(debug.getupvalue(jb.FallingController.Init, 19), 9, "Archivable")
task.spawn(function() while wait() do debug.getupvalue(jb.VehicleController.NitroShopVisible, 1).Nitro = 200 end

task.spawn(function()if not isfolder("JailBreak") then makefolder("JailBreak") end
if not isfolder("JailBreak/RemoteAddresses") then makefolder("JailBreak/RemoteAddresses") end
if not isfile("JailBreak/RemoteAddresses/ArrestAddress.txt") then writefile("JailBreak/RemoteAddresses/ArrestAddress.txt", "") end

local Players = cloneref(game:GetService("Players"))
local lp = cloneref(Players.LocalPlayer)
local Backpack = cloneref(lp:WaitForChild("Folder"))
local MaxArrest = rawget(require(game:GetService("ReplicatedStorage"):WaitForChild("Game"):WaitForChild("ItemConfig"):WaitForChild("Handcuffs")), "ArrestDistance")

if type(MaxArrest) ~= "number" then
   warn("MaxArrest was not a number, setting to default 10.")
   MaxArrest = 10
end

getgenv().autoArrestEnabled = false 
local arrestHook

local function FetchRemote()
	for _, v in ipairs(getgc(false)) do
		if type(v) == "function" and islclosure(v) and debug.info(v, "n") == "EventFireServer" then
			local upvalues = debug.getupvalues(v)
			if typeof(upvalues[2]) == "Instance" and type(upvalues[3]) == "table" then
				return v, cloneref(upvalues[2]), upvalues[3]
			end
		end
	end
	warn("Failed to fetch remote function!")
end

local FunctionHandler, CommunicationRemote, EventTable = FetchRemote()
if not (FunctionHandler and CommunicationRemote and EventTable) then return end

local function GetArrestRemote()
	local ArrestRemoteAddress = rawget(EventTable, readfile("JailBreak/RemoteAddresses/ArrestAddress.txt"))
	if not ArrestRemoteAddress or ArrestRemoteAddress == "" then
		local thread = coroutine.running()
		local BindableFunction = Instance.new("BindableFunction")
		local info = Instance.new("Hint", game:GetService("CoreGui"))
		info.Text = "Failed to retrieve Arrest Address | Please arrest someone"

		function BindableFunction.OnInvoke(address)
			if rawget(EventTable, address) then
				ArrestRemoteAddress = address
				coroutine.resume(thread)
				return true
			end
			return false
		end

		local old = FunctionHandler
		arrestHook = hookfunction(FunctionHandler, function(...)
			if select("#", ...) == 2 then
				local address, plrname = ...
				if type(address) == "string" and type(plrname) == "string" and Players:FindFirstChild(plrname) then
					BindableFunction:Invoke(address)
					return
				end
			end
			return old(...)
		end)

		coroutine.yield()
		if not ArrestRemoteAddress then
			warn("Failed to retrieve ArrestRemoteAddress!")
			return nil
		end
		
		writefile("JailBreak/RemoteAddresses/ArrestAddress.txt", ArrestRemoteAddress)
		info.Text = string.format('Successfully retrieved Arrest Address: "%s"', ArrestRemoteAddress)

		task.delay(10, function()
			info:Destroy()
		end)
	end
	return ArrestRemoteAddress
end

local ArrestRemoteAddress = GetArrestRemote()
if not ArrestRemoteAddress then return end

local Ignorelist = OverlapParams.new()
Ignorelist.FilterType = Enum.RaycastFilterType.Include

local function HasHandCuffs(char)
   return char and char:FindFirstChild("Handcuffs") ~= nil
end

local function IsArrestable(plr)
   if plr and plr.Team then
       if not HasHandCuffs(plr.Character) then
           if plr:GetAttribute("HasEscaped") then
               return true
           elseif plr.Team.Name == "Prisoner" then
               local Items = cloneref(plr:FindFirstChild("Folder"))
               if Items then
                   if Items:FindFirstChild("MansionInvite") then
                       return #Items:GetChildren() > 1
                   end
                   return #Items:GetChildren() > 0
               end
           end
       end
   end
   return false
end

local function getchar(plr, yield)
   plr = plr or lp
   local char = plr.Character or (yield and plr.CharacterAdded:Wait())
   return char and cloneref(char)
end

local function GetPlayers()
   local PlayerList = {}
   for _, v in ipairs(Players:GetPlayers()) do
       if IsArrestable(v) then
           table.insert(PlayerList, getchar(v))
       end
   end
   return PlayerList
end

local function MonitorManualArrest()
	if arrestHook then
		hookfunction(FunctionHandler, arrestHook)
	end
end

local function EnableAutoArrest()
	while getgenv().autoArrestEnabled do
		task.wait()
        local Handcuffs = Backpack:FindFirstChild("Handcuffs") and cloneref(Backpack:FindFirstChild("Handcuffs"))

        if Handcuffs and Handcuffs:GetAttribute("InventoryItemEquipped") then
            local char = getchar(nil, true)
            local Humanoid = char and char:FindFirstChildWhichIsA("Humanoid")
            local RootPart = Humanoid and Humanoid.RootPart
            if RootPart then
                Ignorelist.FilterDescendantsInstances = GetPlayers()

                for _, v in ipairs(workspace:GetPartBoundsInRadius(RootPart.CFrame.Position, MaxArrest, Ignorelist)) do
                    local Model = v:FindFirstAncestorWhichIsA("Model")
                    if Model and not HasHandCuffs(Model) then
                        local Player = Players:GetPlayerFromCharacter(Model)
                        if Player then
                            if not ArrestRemoteAddress then
                                ArrestRemoteAddress = GetArrestRemote()
                                if not ArrestRemoteAddress then return end
                            end
                            CommunicationRemote:FireServer(ArrestRemoteAddress, Player.Name)
                        end
                    end
                end
            end
        end
	end
end

local function StartAutoArrest()
	while true do
		task.wait()
		if getgenv().autoArrestEnabled then
			MonitorManualArrest()
			EnableAutoArrest()
		end
	end
end

task.spawn(StartAutoArrest)

local function ToggleAutoArrest(state)
	getgenv().autoArrestEnabled = state
	if state then
		EnableAutoArrest()
	else
		if arrestHook then
			hookfunction(FunctionHandler, arrestHook)
		end
	end
end

getgenv().StartAutoArrest = function()
	ToggleAutoArrest(true)
end

getgenv().StopAutoArrest = function()
	ToggleAutoArrest(false)
end
end)

local Combat = _G.Main.createFrame(sapien, UDim2.new(0.23, 0, 0.3, 0), nil, "Combat")

local SilentAimEnabled = false
local AimbotEnabled = false
local AttackRange = 500 

local function getNearestTarget()
    local closest, distance = nil, AttackRange
    for _, player in pairs(players:GetPlayers()) do
        if player ~= lplr and player.Team ~= lplr.Team and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local targetPos = player.Character.HumanoidRootPart.Position
            local magnitude = (targetPos - lplr.Character.HumanoidRootPart.Position).Magnitude
            if magnitude < distance then
                closest, distance = player, magnitude
            end
        end
    end
    return closest, distance
end

local HookedFunction
if not HookedFunction then
    HookedFunction = jb.GunController.TransformLocalMousePosition
end

jb.GunController.TransformLocalMousePosition = function(self, pos)
    if SilentAimEnabled then
        local target = getNearestTarget()
        if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
            return target.Character.HumanoidRootPart.Position
        end
    end
    return HookedFunction(self, pos)
end

local OriginalEmit = jb.BulletEmitter.Emit
jb.BulletEmitter.Emit = function(self, origin, direction, ...)
    if AimbotEnabled then
        local target, targetDistance = getNearestTarget()
        if target and targetDistance <= AttackRange then
            local predictedPos = target.Character.HumanoidRootPart.Position + (target.Character.HumanoidRootPart.Velocity * 0.1)

            self.IgnoreList = {workspace}
            self.Whitelist = {target.Character}

            return OriginalEmit(self, origin, (predictedPos - origin).Unit, ...)
        end
    end
   
    self.IgnoreList = {} 
    self.Whitelist = {}

    return OriginalEmit(self, origin, direction, ...)
end

local function toggleSilentAim()
    SilentAimEnabled = not SilentAimEnabled
end

local function toggleAimbot()
    AimbotEnabled = not AimbotEnabled
end

_G.Main.createButton(Combat, "Aimbot(Legit)", toggleSilentAim)
_G.Main.createButton(Combat, "Aimbot(Blatant)", toggleAimbot())

local UIS = cloneref(game:GetService("UserInputService"))
local Utility = _G.Main.createFrame(sapien, UDim2.new(0.6, 0, 0.3, 0), nil, "Utilities") -- Utility Tab
local StrafeEnabled = false
local Target = nil
local StrafeDistance = 5
local StrafeSpeed = 100
local BounceHeight = 7
local BounceSpeed = 100
local BehindDistance = 5
local CollisionCheckDistance = 4
local sg = Instance.new("ScreenGui",lplr.PlayerGui)
local StrafeGUI = Instance.new("Frame")
StrafeGUI.Size = UDim2.new(0, 200, 0, 100)
StrafeGUI.Position = UDim2.new(0.5, -100, 0.4, 0)
StrafeGUI.BackgroundColor3 = Color3.fromRGB(49, 49, 49)
StrafeGUI.Parent = sg
StrafeGUI.Visible = false
StrafeGUI.Active = true
StrafeGUI.Draggable = true

local UICorner = Instance.new("UICorner", StrafeGUI)
UICorner.CornerRadius = UDim.new(0, 10)

local TargetLabel = Instance.new("TextLabel", StrafeGUI)
TargetLabel.Size = UDim2.new(1, 0, 0.5, 0)
TargetLabel.BackgroundTransparency = 1
TargetLabel.Font = Enum.Font.SourceSansBold
TargetLabel.TextSize = 20
TargetLabel.TextScaled = true
TargetLabel.TextColor3 = Color3.fromRGB(255, 255, 255)

local StartButton = Instance.new("TextButton", StrafeGUI)
StartButton.Size = UDim2.new(1, 0, 0.5, 0)
StartButton.Position = UDim2.new(0, 0, 0.5, 0)
StartButton.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
StartButton.Font = Enum.Font.SourceSansBold
StartButton.TextSize = 18
StartButton.Text = "Start Strafe"
StartButton.TextColor3 = Color3.fromRGB(255, 255, 255)

local function isValidTarget(player)
    if not player or not player.Character then return false end
    local team = player.Team and player.Team
    if team ~= lplr.Team then
        local targetRoot = player.Character:FindFirstChild("HumanoidRootPart")
        return targetRoot ~= nil 
    end
    return false
end

local function FindClosestTarget()
    local closest, closestDist = nil, math.huge
    for _, player in ipairs(players:GetPlayers()) do
        if player ~= lplr and isValidTarget(player) then
            local targetRoot = player.Character:FindFirstChild("HumanoidRootPart")
            if targetRoot then
                local dist = (lplr.Character.HumanoidRootPart.Position - targetRoot.Position).Magnitude
                if dist < closestDist then
                    closest, closestDist = player, dist
                end
            end
        end
    end
    return closest
end

local function UpdateStrafeGUI()
    local closestTarget = FindClosestTarget()
    if closestTarget then
        Target = closestTarget.Character
        TargetLabel.Text = closestTarget.Name
        TargetLabel.TextColor3 = closestTarget.TeamColor.Color 
    else
        TargetLabel.Text = "No Target Found"
        TargetLabel.TextColor3 = Color3.fromRGB(255, 0, 0) 
    end
end

local function Strafe()
    if not StrafeEnabled then return end

    local rootPart = lplr.Character and lplr.Character:FindFirstChild("HumanoidRootPart")
    local targetRootPart = Target and Target:FindFirstChild("HumanoidRootPart")
    
    if not rootPart or not targetRootPart then 
        UpdateStrafeGUI()
        return 
    end

    local direction = (rootPart.Position - targetRootPart.Position).Unit
    local behindPosition = targetRootPart.Position - direction * BehindDistance
    behindPosition = Vector3.new(behindPosition.X, targetRootPart.Position.Y, behindPosition.Z)

    local rightDirection = Vector3.new(direction.Z, 0, -direction.X).Unit
    local desiredPosition = behindPosition + rightDirection * StrafeDistance

    local raycastParams = RaycastParams.new()
    raycastParams.FilterDescendantsInstances = {lplr.Character}
    raycastParams.FilterType = Enum.RaycastFilterType.Blacklist

    local raycastResult = workspace:Raycast(rootPart.Position, (desiredPosition - rootPart.Position).Unit * CollisionCheckDistance, raycastParams)
    if raycastResult and raycastResult.Instance ~= targetRootPart then
        desiredPosition = rootPart.Position + (desiredPosition - rootPart.Position).Unit * (raycastResult.Position - rootPart.Position).Magnitude * 0.9
    end

    if (desiredPosition - targetRootPart.Position).Magnitude < 2 then
        desiredPosition = targetRootPart.Position + rightDirection * (StrafeDistance + 2)
    end

    local moveDirection = (desiredPosition - rootPart.Position).Unit
    local moveVelocity = moveDirection * StrafeSpeed
    local verticalVelocity = 0
    local humanoid = Target.Humanoid
    if humanoid:GetState() == Enum.HumanoidStateType.Freefall then
        local verticalOffset = math.sin(tick() * BounceSpeed) * BounceHeight
        verticalVelocity = (targetRootPart.Position.Y + verticalOffset) - rootPart.Position.Y
    end

    rootPart.Velocity = Vector3.new(moveVelocity.X, verticalVelocity, moveVelocity.Z)
end

StartButton.MouseButton1Click:Connect(function()
    StrafeEnabled = not StrafeEnabled
    StartButton.Text = StrafeEnabled and "Stop Strafe" or "Start Strafe"
end)
local runService = cloneref(game:GetService("RunService"))

runService.RenderStepped:Connect(function()
    if StrafeEnabled then
        UpdateStrafeGUI()
        Strafe()
    end
end)

_G.Main.createButton(Utility, "Target Strafe", function()
    StrafeGUI.Visible = not StrafeGUI.Visible
    UpdateStrafeGUI()
end)
local aa = false 
_G.Main.createButton(Utility, "Auto Arrest", function()
        if aa == false then
            aa = true
            getgenv().StartAutoArrest()
       else
               aa = false
              getgenv().StopAutoArrest()
        end
end)

local flying = false
local targetHeight = 10
local speed = 100
local minHeight = 0.5
local heightStep = 4
local holdSpeed = 0.1
local holdUp, holdDown = false, false 

local player = game:GetService("Players").LocalPlayer
local character, root, humanoid
local bv = nil

local function updateCharacter(newCharacter)
    character = newCharacter
    root = character:WaitForChild("HumanoidRootPart")
    humanoid = character:WaitForChild("Humanoid")
    
    if flying then
        toggleFly(true)
    end
end

player.CharacterAdded:Connect(updateCharacter)
if player.Character then
    updateCharacter(player.Character)
end

local FlyGUI = Instance.new("Frame",sg)
FlyGUI.Size = UDim2.new(0.1, 0, 0.1, 0)
FlyGUI.Position = UDim2.new(0.85, 0, 0.4, 0)
FlyGUI.BackgroundTransparency = 1
FlyGUI.Visible = false

local UpButton = Instance.new("TextButton", FlyGUI)
UpButton.Size = UDim2.new(1, 0, 0.5, 0)
UpButton.Position = UDim2.new(0, 0, 0, 0)
UpButton.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
UpButton.Text = "⬆"
UpButton.TextScaled = true
UpButton.Parent = FlyGUI

local DownButton = Instance.new("TextButton", FlyGUI)
DownButton.Size = UDim2.new(1, 0, 0.5, 0)
DownButton.Position = UDim2.new(0, 0, 0.5, 0)
DownButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
DownButton.Text = "⬇"
DownButton.TextScaled = true
DownButton.Parent = FlyGUI

local function getGroundHeight()
    local ray = Ray.new(root.Position, Vector3.new(0, -1000000000, 0)) -- Cast downwards
    local hit, pos = workspace:FindPartOnRayWithIgnoreList(ray, {character})
    return hit and pos.Y or root.Position.Y
end

local function toggleFly(state)
    flying = state or not flying
    FlyGUI.Visible = flying

    if flying then
        if not bv then
            bv = Instance.new("BodyVelocity")
            bv.MaxForce = Vector3.new(1e5, 1e5, 1e5)
            bv.Velocity = Vector3.zero
            bv.Parent = root
        end
        targetHeight = math.max(getGroundHeight() + minHeight, root.Position.Y)
    else
        if bv then bv:Destroy(); bv = nil end
        root.AssemblyLinearVelocity = Vector3.zero
    end
end

game:GetService("RunService").RenderStepped:Connect(function()
    if flying and character and root then
        local moveDirection = humanoid.MoveDirection
        local verticalVelocity = (targetHeight - root.Position.Y) * 5 -- Smooth height adjustment
        bv.Velocity = moveDirection * speed + Vector3.new(0, verticalVelocity, 0)
    end
end)

local function increaseHeight()
    targetHeight = targetHeight + heightStep
end

local function decreaseHeight()
    local groundHeight = getGroundHeight()
    if targetHeight > groundHeight + minHeight then
        targetHeight = targetHeight - heightStep
    end
end

local function startHoldingUp()
    holdUp = true
    while holdUp do
        increaseHeight()
        task.wait(holdSpeed)
    end
end

local function startHoldingDown()
    holdDown = true
    while holdDown do
        decreaseHeight()
        task.wait(holdSpeed)
    end
end

UpButton.MouseButton1Down:Connect(startHoldingUp)
UpButton.MouseButton1Up:Connect(function() holdUp = false end)
UpButton.MouseLeave:Connect(function() holdUp = false end)

DownButton.MouseButton1Down:Connect(startHoldingDown)
DownButton.MouseButton1Up:Connect(function() holdDown = false end)
DownButton.MouseLeave:Connect(function() holdDown = false end)

game:GetService("UserInputService").InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == Enum.KeyCode.F then
        increaseHeight()
    elseif input.KeyCode == Enum.KeyCode.L then
        decreaseHeight()
    end
end)
local flyButton = _G.Main.createButton(Utility, "ToggleFly[F and L]", function() toggleFly() end)

local speedEnabled = false
local ws = 50
local bv = nil

local player = game:GetService("Players").LocalPlayer
local character, root, humanoid
local function updateCharacter(newCharacter)
    character = newCharacter
    root = character:WaitForChild("HumanoidRootPart")
    humanoid = character:WaitForChild("Humanoid")
    if speedEnabled then
        toggleSpeed(true)
    end
end

player.CharacterAdded:Connect(updateCharacter)
if player.Character then
    updateCharacter(player.Character)
end

local function toggleSpeed(state)
    speedEnabled = state or not speedEnabled

    if speedEnabled then
        if not bv then
            bv = Instance.new("BodyVelocity")
            bv.MaxForce = Vector3.new(1e5, 0, 1e5) -- No Y-axis force (jumps work normally)
            bv.Velocity = Vector3.zero
            bv.Parent = root
        end
    else
        if bv then bv:Destroy(); bv = nil end
        root.AssemblyLinearVelocity = Vector3.zero
    end
end

game:GetService("RunService").RenderStepped:Connect(function()
    if speedEnabled and character and root then
        local moveDirection = humanoid.MoveDirection
        bv.Velocity = Vector3.new(moveDirection.X * ws, root.Velocity.Y, moveDirection.Z * speed)
    end
end)

local speedButton = _G.Main.createButton(Utility, "Toggle Speed", function() toggleSpeed() end)
local function updateFlyAndSpeedButtons(flyButton, speedButton)
    local function toggleFly()
        if speedEnabled then
            toggleSpeed(false) -- Disable Speed before enabling Fly
        end
        toggleFly()
        flyButton.BackgroundColor3 = flying and Color3.fromRGB(0, 0, 255) or Color3.fromRGB(255, 255, 255)
        speedButton.BackgroundColor3 = Color3.fromRGB(255, 255, 255) -- Reset Speed button color
    end

    local function toggleSpeed()
        if flying then
            toggleFly(false)
        end
        toggleSpeed()
        speedButton.BackgroundColor3 = speedEnabled and Color3.fromRGB(0, 0, 255) or Color3.fromRGB(255, 255, 255)
        flyButton.BackgroundColor3 = Color3.fromRGB(255, 255, 255) -- Reset Fly button color
    end
    
end

updateFlyAndSpeedButtons(FlyButton, SpeedButton)
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

local Visuals = _G.Main.createFrame(sapien, UDim2.new(0.23, 0, 0.8, 0), nil, "Visuals")

local ESP_Boxes = {} 
local ESP_Names = {} 
local ESP_Tracers = {} 


local ESP_Enabled = false
local Names_Enabled = false
local Tracers_Enabled = false


local function removeESP(player)
    if ESP_Boxes[player] then ESP_Boxes[player]:Remove() ESP_Boxes[player] = nil end
    if ESP_Names[player] then ESP_Names[player]:Remove() ESP_Names[player] = nil end
    if ESP_Tracers[player] then ESP_Tracers[player]:Remove() ESP_Tracers[player] = nil end
end


local function createESP(player)
    if player == LocalPlayer then return end  
    removeESP(player) -- ✅ Ensure no duplicate ESP

    ESP_Boxes[player] = Drawing.new("Square")
    ESP_Boxes[player].Thickness = 2
    ESP_Boxes[player].Filled = false
    ESP_Boxes[player].Visible = false

    ESP_Names[player] = Drawing.new("Text")
    ESP_Names[player].Size = 18
    ESP_Names[player].Center = true
    ESP_Names[player].Outline = true
    ESP_Names[player].Visible = false

    ESP_Tracers[player] = Drawing.new("Line")
    ESP_Tracers[player].Thickness = 2
    ESP_Tracers[player].Visible = false

   
    player.CharacterRemoving:Connect(function()
        removeESP(player)
    end)
end

for _, player in ipairs(Players:GetPlayers()) do
    createESP(player)
end

Players.PlayerAdded:Connect(function(player)
    createESP(player)
    player.CharacterAdded:Connect(function()
        createESP(player)
    end)
end)

Players.PlayerRemoving:Connect(removeESP)


local function updateESP()
    for _, player in ipairs(Players:GetPlayers()) do
        -- Ensure ESP exists
        if not ESP_Boxes[player] then
            createESP(player)
        end

        local box = ESP_Boxes[player]
        local nameTag = ESP_Names[player]
        local tracer = ESP_Tracers[player]
        local character = player.Character
        local hrp = character and character:FindFirstChild("HumanoidRootPart")
        local humanoid = character and character:FindFirstChild("Humanoid")

        if box and nameTag and tracer and hrp and humanoid then
            local screenPos, onScreen = Camera:WorldToViewportPoint(hrp.Position)

            if onScreen then
                local charHeight = humanoid.HipHeight + 2.5  
                local width = charHeight * 1.2 
                local height = charHeight * 2.2

                local topScreenPos = Camera:WorldToViewportPoint(hrp.Position + Vector3.new(0, height / 2, 0))
                local bottomScreenPos = Camera:WorldToViewportPoint(hrp.Position - Vector3.new(0, height / 2, 0))

                height = math.abs(topScreenPos.Y - bottomScreenPos.Y)
                width = height * 0.6 

                local color = (player.Team == LocalPlayer.Team) and Color3.new(0, 0, 1) or Color3.new(1, 0, 0)

               
                box.Visible = ESP_Enabled
                box.Size = Vector2.new(width, height)
                box.Position = Vector2.new(screenPos.X - width / 2, screenPos.Y - height / 2)
                box.Color = color

                nameTag.Visible = Names_Enabled
                nameTag.Position = Vector2.new(screenPos.X, screenPos.Y - height / 2 - 15)
                nameTag.Text = player.Name
                nameTag.Color = color

                tracer.Visible = Tracers_Enabled
                tracer.From = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y)
                tracer.To = Vector2.new(screenPos.X, screenPos.Y)
                tracer.Color = color
            else
                box.Visible = false
                nameTag.Visible = false
                tracer.Visible = false
            end
        else
            removeESP(player)
        end
    end
end

RunService.RenderStepped:Connect(updateESP)

_G.Main.createButton(Visuals, "Toggle ESP", function()
    ESP_Enabled = not ESP_Enabled
end)

_G.Main.createButton(Visuals, "Toggle Names", function()
    Names_Enabled = not Names_Enabled
    
end)

_G.Main.createButton(Visuals, "Toggle Tracers", function()
    Tracers_Enabled = not Tracers_Enabled
    
end)

TextButton2.MouseButton1Click:Connect(function()
       sapien.Enabled = not sapien.Enabled
end)